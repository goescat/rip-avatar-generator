<!DOCTYPE html>

<head>
  <title>離職照片產生器</title>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    h1 {
      text-align: center;
    }

    .description {
      text-align: center;
      color: #141414;
      font-size: 14px;
      margin-bottom: 10px;
      margin-top: 10px;
      margin-left: 10px;
      margin-right: 10px;
    }


    body {
      margin: 0;
      padding: 10px;
      font-family: sans-serif;
      box-sizing: border-box;
      justify-content: center;
      align-items: center;
      color: #141414;
      text-align: center;

    }

    .toolbar {
      flex-direction: row;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    .canvas-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      border: 1px solid #ccc;
      display: block;
    }


    .toolbar {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    button,
    select {
      margin: 2px;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    button {
      background: #f5f5f5;
      cursor: pointer;
    }

    button:hover {
      background: #e5e5e5;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .divider {
      width: 1px;
      height: 30px;
      background: #ccc;
      margin: 0 10px;
    }
  </style>
</head>

<body>
  <h1>離職照片產生器</h1>
  <div class="description">

    之前離職的時候，在 last day 我把 Slack 的頭像換成了有黑色緞帶和小白花裝飾遺照 style 相片，<br>
    然後同事問我：「這是哪裡來的產生器？」<br>
    所以我就做了這個產生器。<br><br>
    等 slack 帳號被 deactivate 之後，照片會變成黑白的，<br>
    好同事們在因為這人寫這三小幹扣，還沒有半點文件的時候考古對話串看到這樣的頭像，<br>
    一定會覺得非常的莊嚴吧。<br>
    <br>
    最後最後，這個產生器不會收集任何個人資料，也不會儲存你的圖片，請放心，而且我也沒錢存檔案啦。<br>
    <br>

  </div>

  <div class="toolbar">
    <div class="control-group">
      <input type="file" id="upload" accept="image/*" style="display: none;">
      <label for="upload"
        style="display: inline-block; padding: 8px 16px; background-color: #7d7a6c; color: white; cursor: pointer; border-radius: 4px;">
        選擇紀念照片
      </label>
      <button onclick="sendToBack()">照片到最下面</button>

    </div>


    <div class="divider"></div>

    <div class="control-group">
      <label>選擇緞帶：
        <select id="frameSelect">
          <option value="">無</option>
          <option value="/rip-avatar-generator/img/black_ribbon_1.png">肅穆黑</option>
          <option value="/rip-avatar-generator/img/red_ribbon_1.png">幻變星河</option>
        </select>
      </label>
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <label>裝飾品：</label>
      <button onclick="addDecoration('/rip-avatar-generator/img/red_flower.png')">紅花</button>
      <button onclick="addDecoration('/rip-avatar-generator/img/black_flower.png')">黑花</button>
      <button onclick="addDecoration('/rip-avatar-generator/img/gray_flower.png')">銀花</button>
      <button onclick="addDecoration('/rip-avatar-generator/img/flower.png')">雛菊</button>
      <button onclick="addDecoration('/rip-avatar-generator/img/flower2.png')">白菊</button>
      <button onclick="addDecoration('/rip-avatar-generator/img/we_miss_you.png')">我們懷念他</button>
    </div>

    <div class="divider"></div>

    <button onclick="deleteSelected()">刪除選中裝飾</button>

    <div class="divider"></div>

    <div class="control-group">
      <button onclick="downloadImage()"
        style="display: inline-block; padding: 8px 16px; background-color: #61b54c; color: white;">下載照片</button>
    </div>
  </div>

  <div class="canvas-wrapper">
    <canvas id="c" width="600" height="600"></canvas>
  </div>

  <script>
    const canvas = new fabric.Canvas('c');
    let backgroundImage;
    let frameImage;

    // 設置畫布背景為白色
    canvas.backgroundColor = '#ffffff';

    // 上傳背景圖
    document.getElementById('upload').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (f) {
        fabric.Image.fromURL(f.target.result, function (img) {
          // 移除之前的背景圖片
          if (backgroundImage) {
            canvas.remove(backgroundImage);
          }

          backgroundImage = img;

          // 設置圖片可以被選中和編輯
          img.selectable = true;
          img.evented = true;

          // 計算合適的初始大小（保持比例，適合畫布）
          const maxSize = Math.min(canvas.width * 0.8, canvas.height * 0.8);
          const scale = Math.min(maxSize / img.width, maxSize / img.height);
          img.scale(scale);

          // 將圖片置中
          img.left = (canvas.width - img.getScaledWidth()) / 2;
          img.top = (canvas.height - img.getScaledHeight()) / 2;

          // 添加到畫布
          canvas.add(img);

          // 選中新添加的圖片
          canvas.setActiveObject(img);
          canvas.renderAll();
        });
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // 套用邊框
    document.getElementById('frameSelect').addEventListener('change', function (e) {
      const src = e.target.value;
      if (!src) {
        if (frameImage) {
          canvas.remove(frameImage);
          frameImage = null;
        }
        canvas.renderAll();
        return;
      }

      fabric.Image.fromURL(src, function (img) {
        img.selectable = false;
        img.evented = false;
        img.scaleToWidth(canvas.width);
        img.top = 0;
        img.left = 0;

        if (frameImage) {
          canvas.remove(frameImage);
        }
        frameImage = img;
        canvas.add(frameImage);

        canvas.setActiveObject(frameImage);
        canvas.renderAll();
      }, { crossOrigin: 'anonymous' });
    });

    // 加入裝飾品
    function addDecoration(src) {
      fabric.Image.fromURL(src, function (img) {
        img.scale(0.3);
        img.left = 100 + Math.random() * 200;
        img.top = 100 + Math.random() * 200;
        img.selectable = true;
        img.evented = true;
        canvas.add(img);

        // 選中新添加的裝飾品
        canvas.setActiveObject(img);
        canvas.renderAll();
      }, { crossOrigin: 'anonymous' });
    }


    // 刪除選中的物件
    function deleteSelected() {
      const activeObject = canvas.getActiveObject();
      if (activeObject) {
        canvas.remove(activeObject);
        canvas.renderAll();
      }
    }

    function sendToBack() {
      if (backgroundImage) {
        canvas.discardActiveObject();
        // 將底圖送到最下層
        canvas.sendToBack(backgroundImage);
      }
    }

    // 鍵盤快捷鍵支持
    document.addEventListener('keydown', function (e) {
      // Delete 或 Backspace 鍵刪除選中物件
      if ((e.key === 'Delete' || e.key === 'Backspace') && canvas.getActiveObject()) {
        deleteSelected();
      }
    });

    function downloadImage() {
      canvas.discardActiveObject();
      canvas.renderAll();
      const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0, multiplier: 2 });

      if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
        // 手機：打開圖片分頁
        const newTab = window.open();
        newTab.document.write(`<img src="${dataURL}" style="max-width:100%;height:auto;">`);
        newTab.document.title = '長按圖片另存新檔';
      } else {
        // 桌機：直接下載
        const link = document.createElement('a');
        link.download = 'memorial_avatar.png';
        link.href = dataURL;
        link.click();
      }
    }


    // // 匯出圖檔
    // function downloadImage() {
    //   canvas.discardActiveObject();
    //   canvas.renderAll();
    //   const link = document.createElement('a');
    //   link.download = 'memorial_avatar.png';
    //   link.href = canvas.toDataURL({
    //     format: 'png',
    //     quality: 1.0,
    //     multiplier: 2
    //   });

    //   link.click();
    // }
  </script>
</body>

</html>